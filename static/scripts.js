/*!
* Start Bootstrap - Grayscale v7.0.5 (https://startbootstrap.com/theme/grayscale)
* Copyright 2013-2022 Start Bootstrap
* Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-grayscale/blob/master/LICENSE)
*/
//
// Scripts
// 


// TODO: delete
response = {
  "num_of_images": -1,
  "i_bright_rate": [
      [
          0.48525490196078436,
          "desc",
          "images\\tiki.png"
      ],
      [
          0.6252156862745099,
          "desc",
          "images\\tiki_new.png"
      ],
      [
          0.4996707818930042,
          "desc",
          "images\\2.png"
      ],
      [
          0.6840084388185653,
          "desc",
          "images\\3.png"
      ],
      [
          0.40434782608695646,
          "desc",
          "images\\4.png"
      ],
      [
          0.4330196078431372,
          "desc",
          "images\\5.png"
      ],
      [
          0.8119215686274509,
          "desc",
          "images\\6.png"
      ],
      [
          0.48637096774193544,
          "desc",
          "images\\7.png"
      ],
      [
          0.41052000000000005,
          "desc",
          "images\\8.png"
      ],
      [
          0.7469803921568626,
          "desc",
          "images\\9.png"
      ]
  ],
  "i_messy_rate": [
      [
          0.1211819052696228,
          "desc",
          "images\\tiki.png"
      ],
      [
          0.1013462245464325,
          "desc",
          "images\\tiki_new.png"
      ],
      [
          0.9259664416313171,
          "desc",
          "images\\2.png"
      ],
      [
          0.1190466582775116,
          "desc",
          "images\\3.png"
      ],
      [
          0.6015366315841675,
          "desc",
          "images\\4.png"
      ],
      [
          0.7122364044189453,
          "desc",
          "images\\5.png"
      ],
      [
          0.05697524547576904,
          "desc",
          "images\\6.png"
      ],
      [
          0.9428436756134033,
          "desc",
          "images\\7.png"
      ],
      [
          0.8530024886131287,
          "desc",
          "images\\8.png"
      ],
      [
          0.1281992793083191,
          "desc",
          "images\\9.png"
      ]
  ],
  "i_triq_model": [
    [
        0.48525490196078436,
        "desc",
        "images\\tiki.png"
    ],
    [
        0.7252156862745099,
        "desc",
        "images\\tiki_new.png"
    ],
    [
        0.4996707818930042,
        "desc",
        "images\\2.png"
    ],
    [
        0.6840084388185653,
        "desc",
        "images\\3.png"
    ],
    [
        0.40434782608695646,
        "desc",
        "images\\4.png"
    ],
    [
        0.4330196078431372,
        "desc",
        "images\\5.png"
    ],
    [
        0.6019215686274509,
        "desc",
        "images\\6.png"
    ],
    [
        0.48637096774193544,
        "desc",
        "images\\7.png"
    ],
    [
        0.30052000000000005,
        "desc",
        "images\\8.png"
    ],
    [
        0.7469803921568626,
        "desc",
        "images\\9.png"
    ]
],
  "i_quality_rate": [
    [
        0.48525490196078436,
        "desc",
        "images\\tiki.png"
    ],
    [
        0.6252156862745099,
        "desc",
        "images\\tiki_new.png"
    ],
    [
        0.5996707818930042,
        "desc",
        "images\\2.png"
    ],
    [
        0.7140084388185653,
        "desc",
        "images\\3.png"
    ],
    [
        0.40434782608695646,
        "desc",
        "images\\4.png"
    ],
    [
        0.4330196078431372,
        "desc",
        "images\\5.png"
    ],
    [
        0.8119215686274509,
        "desc",
        "images\\6.png"
    ],
    [
        0.48637096774193544,
        "desc",
        "images\\7.png"
    ],
    [
        0.41052000000000005,
        "desc",
        "images\\8.png"
    ],
    [
        0.7469803921568626,
        "desc",
        "images\\9.png"
    ]
],
  "grammar_model": {'issues': ['Possible spelling mistake found.', 'This sentence does not start with an uppercase letter.'], 'main_response': 'Please notice several grammar corrections', 'grade': 55, 'replacement_description': 'The apartment is big and beautiful, you should come see it'},
  "semantic_model": [0.8119215686274509,
    "semantic main response"],
  "punctuation_model": [0.9619215686274509,
    "punctuation main response"]
}

allReportsResponse = {
  0: {
    "photos": {},
    "description": "First Report",
    "num_of_images": -1,
    "i_bright_rate": [
        [
            0.48525490196078436,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.6252156862745099,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_messy_rate": [
        [
            0.1211819052696228,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.1013462245464325,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_triq_model": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.7252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "i_quality_rate": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.6252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "grammar_model": {'issues': ['Possible spelling mistake found.', 'This sentence does not start with an uppercase letter.'], 'main_response': 'Please notice several grammar corrections', 'grade': 55, 'replacement_description': 'The apartment is big and beautiful, you should come see it'},
    "semantic_model": [0.8119215686274509,
      "semantic main response"],
    "punctuation_model": [0.9619215686274509,
      "punctuation main response"]  
  },
  1: {
    "photos": {},
    "description": "Second Report",
    "num_of_images": "not enough images",
    "i_bright_rate": [
        [
            0.48525490196078436,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.6252156862745099,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_messy_rate": [
        [
            0.1211819052696228,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.1013462245464325,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_triq_model": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.7252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "i_quality_rate": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.6252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "grammar_model": {'issues': ['Possible spelling mistake found.', 'This sentence does not start with an uppercase letter.'], 'main_response': 'Please notice several grammar corrections', 'grade': 55, 'replacement_description': 'The apartment is big and beautiful, you should come see it'},
    "semantic_model": [0.8119215686274509,
      "semantic main response"],
    "punctuation_model": [0.9619215686274509,
      "punctuation main response"]  
  },
  2: {
    "photos": {},
    "description": "Third Report",
    "num_of_images": -1,
    "i_bright_rate": [
        [
            0.48525490196078436,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.6252156862745099,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_messy_rate": [
        [
            0.1211819052696228,
            "desc",
            "images\\photoName.png"
        ],
        [
            0.1013462245464325,
            "desc",
            "images\\photoName1.png"
        ]
    ],
    "i_triq_model": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.7252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "i_quality_rate": [
      [
          0.48525490196078436,
          "desc",
          "images\\photoName.png"
      ],
      [
          0.6252156862745099,
          "desc",
          "images\\photoName1.png"
      ]
  ],
    "grammar_model": {'issues': ['Possible spelling mistake found.', 'This sentence does not start with an uppercase letter.'], 'main_response': 'Please notice several grammar corrections', 'grade': 55, 'replacement_description': 'The apartment is big and beautiful, you should come see it'},
    "semantic_model": [0.8119215686274509,
      "semantic main response"],
    "punctuation_model": [0.9619215686274509,
      "punctuation main response"]  
  }
}
// TODO: delete also photoinb.txt file
window.addEventListener('DOMContentLoaded', event => {
  var rawFile = new XMLHttpRequest();
  rawFile.open("GET", "static/photoinb.txt", false);
  rawFile.onreadystatechange = function ()
  {
    if(rawFile.readyState === 4)
    {
      if(rawFile.status === 200 || rawFile.status == 0)
      {
        var allText = rawFile.responseText;
        allReportsResponse[1].photos = {};
        allReportsResponse[1].photos["photoName.png"] = allText;
        allReportsResponse[1].photos["photoName1.png"] = allText;
        console.log(allReportsResponse);
      }
    }
  }
  rawFile.send(null);
});


window.addEventListener('DOMContentLoaded', event => {

    // Navbar shrink function
    var navbarShrink = function () {
        const navbarCollapsible = document.body.querySelector('#mainNav');
        if (!navbarCollapsible) {
            return;
        }
        if (window.scrollY === 0) {
            navbarCollapsible.classList.remove('navbar-shrink')
        } else {
            navbarCollapsible.classList.add('navbar-shrink')
        }

    };

    // Shrink the navbar 
    navbarShrink();

    // Shrink the navbar when page is scrolled
    document.addEventListener('scroll', navbarShrink);

    // Activate Bootstrap scrollspy on the main nav element
    const mainNav = document.body.querySelector('#mainNav');
    if (mainNav) {
        new bootstrap.ScrollSpy(document.body, {
            target: '#mainNav',
            offset: 74,
        });
    };

    // Collapse responsive navbar when toggler is visible
    const navbarToggler = document.body.querySelector('.navbar-toggler');
    const responsiveNavItems = [].slice.call(
        document.querySelectorAll('#navbarResponsive .nav-link')
    );
    responsiveNavItems.map(function (responsiveNavItem) {
        responsiveNavItem.addEventListener('click', () => {
            if (window.getComputedStyle(navbarToggler).display !== 'none') {
                navbarToggler.click();
            }
        });
    });

});

function showDiv() {
    var oneOrMoreIsSelected = 0;
    var descriptionButton = document.getElementById("btncheck1");
    var imagesButton = document.getElementById("btncheck2");
    if (descriptionButton.checked) {
        document.getElementById("uploadDescriptionDiv").className = '';
        document.getElementById("sendDataDiv").style.visibility = 'visible';
        oneOrMoreIsSelected = 1;
    }
    else {
        document.getElementById("uploadDescriptionDiv").className = 'hidden';
    }
    if (imagesButton.checked) {
        document.getElementById("uploadImagesDiv").className = '';
        document.getElementById("sendDataDiv").style.visibility = 'visible';
        oneOrMoreIsSelected = 1;
    } 
    else {
        document.getElementById("uploadImagesDiv").className = 'hidden';
    }
    if (oneOrMoreIsSelected == 0) {
        document.getElementById("sendDataDiv").style.visibility = 'hidden';
    }
}
  
// Attach click listeners onload
window.onload = function() {
[].forEach.call(document.querySelectorAll('[name="selectActions"]'), function(button) {
    button.onclick = showDiv;
    [].forEach.call(document.querySelectorAll('[name="selectActions"]'), function(button){
        document.getElementById(button.dataset.divid).className = 'hidden';
    })
    })
    document.getElementById("sendDataDiv").style.visibility = 'hidden';
}

var files = [];
var loginWay;
var emailLogin;
var descriptionFromUser;
function sendOnClick() {
  if (loginWay != null && loginWay != "") {
    var formData = new FormData();
    descriptionFromUser = document.getElementById('descriptionFromUser').value
    formData.append('descriptionText', descriptionFromUser)
    formData.append('email', emailLogin)
    if (typeof(files) != 'undefined') {
      if (files.size != 0) {
        for (var i = 0, f; (f = files[i]); i++) {
          formData.append('photosInfo', f)
        }
        console.log(formData.getAll('photosInfo'))
      }
    }
    console.log(formData.getAll('descriptionText'))

    const Http = new XMLHttpRequest();
    const url = '/';
    Http.open("POST", url);
    Http.send(formData);
    document.getElementById("ResponseBanner").className = '';

    Http.onreadystatechange = (e) => {
      if(Http.readyState === XMLHttpRequest.DONE) {
        document.getElementById("responseSpinner").className = 'hidden';
        console.log("response from server is:", Http.responseText)
        if (descriptionFromUser != "undefined" && descriptionFromUser != "") {
          document.getElementById("descriptionAccordion").className = 'accordion-item';
          loadDescriptionBanner(Http);
        }
        // TODO: add a check if images were uploaded
        document.getElementById("imagesAccordion").className = 'accordion-item';
        // TODO: change response to Http
        accordionImages = document.getElementById("accordionImages");
        accordionImages.innerHTML = '';
        accordionImages.appendChild(loadImagesBanner(response, files));
      }
    }

    var allReportsformData = new FormData();
    allReportsformData.append('email', emailLogin);  

    const allReportsRequest = new XMLHttpRequest();
    const allReportsUrl = '/getAllReports';
    allReportsRequest.open("POST", allReportsUrl);
    allReportsRequest.send(allReportsformData);

    allReportsRequest.onreadystatechange = (e) => {
      if(allReportsRequest.readyState === XMLHttpRequest.DONE) {
        var reportsResponse = eval('('+ allReportsRequest.responseText + ')');
        loadAllReports(reportsResponse);
      }
    }
  }
  else {
    var myModal = new bootstrap.Modal(document.getElementById('loginModal'))
    myModal.show()
    console.log("The user is not logged in")
  }
}

//I added event handler for the file upload control to access the files properties.
document.addEventListener("DOMContentLoaded", init, false);

//To save an array of attachments
var AttachmentArray = [];

//counter for attachment array
var arrCounter = 0;

//to make sure the error message for number of files will be shown only one time.
var filesCounterAlertStatus = false;

//un ordered list to keep attachments thumbnails
var ul = document.createElement("ul");
ul.className = "thumb-Images";
ul.id = "imgList";

function init() {
  //add javascript handlers for the file upload event
  document
    .querySelector("#files")
    .addEventListener("change", handleFileSelect, false);
}

//the handler for file upload event
function handleFileSelect(e) {
  //to make sure the user select file/files
  if (!e.target.files) return;

  //To obtaine a File reference
  var newFiles = e.target.files;
  for (var i = 0, l = newFiles.length; i < l; i++) {
    files.push(newFiles[i]);
  }
  console.log(files);

  // Loop through the FileList and then to render image files as thumbnails.
  for (var i = 0, f; (f = newFiles[i]); i++) {
    //instantiate a FileReader object to read its contents into memory
    var fileReader = new FileReader();

    // Closure to capture the file information and apply validation.
    fileReader.onload = (function(readerEvt) {
      return function(e) {
        //Apply the validation rules for attachments upload
        ApplyFileValidationRules(readerEvt);

        //Render attachments thumbnails.
        RenderThumbnail(e, readerEvt);

        //Fill the array of attachment
        FillAttachmentArray(e, readerEvt);
      };
    })(f);

    // Read in the image file as a data URL.
    // readAsDataURL: The result property will contain the file/blob's data encoded as a data URL.
    // More info about Data URI scheme https://en.wikipedia.org/wiki/Data_URI_scheme
    fileReader.readAsDataURL(f);
  }
  document
    .getElementById("files")
    .addEventListener("change", handleFileSelect, false);
}

//To remove attachment once user click on x button
jQuery(function($) {
  $("div").on("click", ".img-wrap .close", function() {
    var id = $(this)
      .closest(".img-wrap")
      .find("img")
      .data("id");

    //to remove the deleted item from array
    var elementPos = AttachmentArray.map(function(x) {
      return x.FileName;
    }).indexOf(id);
    if (elementPos !== -1) {
      AttachmentArray.splice(elementPos, 1);
      files.splice(elementPos, 1);
    }

    //to remove image tag
    $(this)
      .parent()
      .find("img")
      .not()
      .remove();

    //to remove div tag that contain the image
    $(this)
      .parent()
      .find("div")
      .not()
      .remove();

    //to remove div tag that contain caption name
    $(this)
      .parent()
      .parent()
      .find("div")
      .not()
      .remove();

    //to remove li tag
    var lis = document.querySelectorAll("#imgList li");
    for (var i = 0; (li = lis[i]); i++) {
      if (li.innerHTML == "") {
        li.parentNode.removeChild(li);
      }
    }
  });
});

//Apply the validation rules for attachments upload
function ApplyFileValidationRules(readerEvt) {
  //To check file type according to upload conditions
  if (CheckFileType(readerEvt.type) == false) {
    alert(
      "The file (" +
        readerEvt.name +
        ") does not match the upload conditions, You can only upload jpg/png/gif files"
    );
    e.preventDefault();
    return;
  }

  //To check file Size according to upload conditions
  if (CheckFileSize(readerEvt.size) == false) {
    alert(
      "The file (" +
        readerEvt.name +
        ") does not match the upload conditions, The maximum file size for uploads should not exceed 300 KB"
    );
    e.preventDefault();
    return;
  }

  //To check files count according to upload conditions
  if (CheckFilesCount(AttachmentArray) == false) {
    if (!filesCounterAlertStatus) {
      filesCounterAlertStatus = true;
      alert(
        "You have added more than 30 files. According to upload conditions you can upload 30 files maximum"
      );
    }
    e.preventDefault();
    return;
  }
}

//To check file type according to upload conditions
function CheckFileType(fileType) {
  if (fileType == "image/jpeg") {
    return true;
  } else if (fileType == "image/png") {
    return true;
  } else if (fileType == "image/gif") {
    return true;
  } else {
    return false;
  }
  return true;
}

//To check file Size according to upload conditions
function CheckFileSize(fileSize) {
  if (fileSize < 300000000) {
    return true;
  } else {
    return false;
  }
  return true;
}

//To check files count according to upload conditions
function CheckFilesCount(AttachmentArray) {
  //Since AttachmentArray.length return the next available index in the array,
  //I have used the loop to get the real length
  var len = 0;
  for (var i = 0; i < AttachmentArray.length; i++) {
    if (AttachmentArray[i] !== undefined) {
      len++;
    }
  }
  //To check the length does not exceed 10 files maximum
  if (len > 30) {
    return false;
  } else {
    return true;
  }
}

//Render attachments thumbnails.
function RenderThumbnail(e, readerEvt) {
  var li = document.createElement("li");
  ul.appendChild(li);
  li.innerHTML = [
    '<div class="img-wrap"> <span class="close">&times;</span>' +
      '<img class="thumb" src="',
    e.target.result,
    '" title="',
    escape(readerEvt.name),
    '" data-id="',
    readerEvt.name,
    '"/>' + "</div>"
  ].join("");

  var div = document.createElement("div");
  div.className = "FileNameCaptionStyle";
  li.appendChild(div);
  div.innerHTML = [readerEvt.name].join("");
  document.getElementById("Filelist").insertBefore(ul, null);
}

//Fill the array of attachment
function FillAttachmentArray(e, readerEvt) {
  AttachmentArray[arrCounter] = {
    AttachmentType: 1,
    ObjectType: 1,
    FileName: readerEvt.name,
    FileDescription: "Attachment",
    NoteText: "",
    MimeType: readerEvt.type,
    Content: e.target.result.split("base64,")[1],
    FileSizeInBytes: readerEvt.size
  };
  arrCounter = arrCounter + 1;
}

function signOut() {
  var auth2 = gapi.auth2.getAuthInstance();
  auth2.signOut().then(function () {
  const listItem = document.getElementById("logoutButton");
  const loginItem = document.createElement('li');
  loginItem.setAttribute("id", "loginButton");
  loginItem.innerHTML = '<a type="button" class="navbar-brand" data-toggle="modal" data-target="#loginModal">Login</a>';
  listItem.replaceWith(loginItem); 
  console.log('User signed out.');
  });
  loginWay = ""
  document.getElementById("loggedIn").className = 'hidden';
}

function generalLogin(loggedName, email) {
  emailLogin = email;
  const listItem = document.getElementById("loginButton");
  const loginItem = document.createElement('li');
  loginItem.innerHTML = '<a type="button" class="navbar-brand" data-toggle="modal" data-target="#loginModal">Login</a>';
  
  const newItem = document.createElement('li');
  newItem.setAttribute("id", "logoutButton");
  var signOutHTML;
  if (loggedName != undefined && loggedName != "") {
    loggedName = ', '+loggedName;
    signOutHTML = '                    <div class="dropdown">'+
'<a href="#" class="navbar-brand dropdown-toggle" data-bs-toggle="dropdown">Hello'+
loggedName+
'</a>'+
'<div class="dropdown-menu">'+
'    <a href="#" class="dropdown-item" onclick="signOut();">Sign Out</a>'+
'</div>'+
'</div>';
  } 
  
  else{
    signOutHTML = '                    <div class="dropdown">'+
'<a href="#" class="navbar-brand dropdown-toggle" data-bs-toggle="dropdown">Hello'+
'</a>'+
'<div class="dropdown-menu">'+
'    <a href="#" class="dropdown-item" onclick="signOut();">Sign Out</a>'+
'</div>'+
'</div>';
  }
  newItem.innerHTML = signOutHTML;
  listItem.parentNode.replaceChild(newItem, listItem); 
  document.getElementById("loggedIn").className = '';
  document.getElementById("emailOrPasswordIncorrect").className = 'hidden';
}

function attachSignin(element) {
  auth2.attachClickHandler(element, {},
      function(googleUser) {
        var profile = googleUser.getBasicProfile();
        console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
        console.log('Name: ' + profile.getName());
        console.log('Image URL: ' + profile.getImageUrl());
        console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
        loginWay = 'Google';
        var loggedName = profile.getName();
        generalLogin(loggedName, profile.getEmail())
      }, function(error) {
        alert(JSON.stringify(error, undefined, 2));
      });
}

function signupForm() {
  userName = document.getElementById("username2").value;
  password = document.getElementById("password2").value;
  name = document.getElementById("name2").value;
  email = document.getElementById("email2").value;
  console.log("signup info: {username:", userName,", password:", password,", name:", name,", email:", email,"}")
  var formData = new FormData();
  formData.append('userName', userName);
  formData.append('password', password);
  formData.append('name', name);
  formData.append('email', email);
  const Http = new XMLHttpRequest();
  const url = '/signUp';
  Http.open("POST", url);
  Http.send(formData);
  Http.onreadystatechange = (e) => {
    if(Http.readyState === XMLHttpRequest.DONE) {
      if (Http.responseText == 1) {
        document.getElementById("emailIsTaken").className = 'hidden';
        document.getElementById("validSignup").className = '';
        console.log("Sign up succeeded");
      }
      else {
        document.getElementById("emailIsTaken").className = '';
        console.log("Email is already taken");
      }
    }
  }
}

function verifyLogin(email, password) {
  var formData = new FormData();
  formData.append('email', email);
  formData.append('password', password);

  const Http = new XMLHttpRequest();
  const url = '/verifyLogin';
  Http.open("POST", url);
  Http.send(formData);

  Http.onreadystatechange = (e) => {
    if(Http.readyState === XMLHttpRequest.DONE) {
      console.log("response for sign in from server is:", Http.responseText)
      if (Http.responseText != 0) {
        var loggedName = Http.responseText;
        generalLogin(loggedName, email);
        loginWay = 'Local'
        console.log("User credentials are valid! The user has logged in");    
      }
      else {
        document.getElementById("emailOrPasswordIncorrect").className = '';
        console.log("Email or password is incorrect");    
      }
    }
  }
}

function loginForm() {
  email = document.getElementById("email1").value;
  password = document.getElementById("password1").value;
  console.log("sign in info: {email:", email,", password:", password,"}")
  verifyLogin(email, password);
}

function colorGradeDecider(grade) {
  if (grade > 85) {
    return "green";
  }
  if (grade > 60) {
    return "orange";
  }
  return "red"
}

function colorBrightnessGradeDecider(grade) {
  if (grade > 90  || grade < 30) {
    return "red";
  }
  if (grade > 80 || grade < 45) {
    return "orange";
  }
  return "green"
}

function colorMessGradeDecider(grade) {
  if (grade > 85) {
    return "red";
  }
  if (grade > 60) {
    return "orange";
  }
  return "green"
}

function grammarDescriptionIssuesList(report) {
  if (report.grammar_model.issues && report.grammar_model.issues.length > 0) {
    var ul = document.createElement("ul");
    ul.textContent = "Possible issues are: "
    ul.style.textAlign = "left"
    for (let i = 0; i < report.grammar_model.issues.length; i++) {
      var li = document.createElement("li");
      li.appendChild(document.createTextNode(report.grammar_model.issues[i]));
      li.style.textAlign = "left"
      ul.appendChild(li);
    }
    return ul;
  }
}

function loadDescriptionBanner(Http) {
  var accordionDescription = document.getElementById("accordionDescription");
  accordionDescription.innerHTML = '';

  accordionDescription.appendChild(getCurrentDescription(response))
  accordionDescription.appendChild(createDescriptionModelsAnalysis(response));  
  accordionDescription.appendChild(createDescriptionChart(response));  
}

function getCurrentDescription(report) {
  var p = document.createElement("p");
  p.textContent = descriptionFromUser;
  p.className = "boxed";
  return p;
}

function createDescriptionChart(report) {
  var div = document.createElement("div");
  div.className = "canvas-container";

  var canvas = document.createElement("canvas");
  canvas.style.width = "100%";
  canvas.style.maxWidth = "600px";

  var grammarGrade = report.grammar_model.grade;
  var semanticGrade = Math.round(report.semantic_model[0] * 100);
  var punctuationGrade = Math.round(report.punctuation_model[0] * 100);
  var xValues = ["Grammar", "Positive semantic", "Punctuation"];
  var yValues = [grammarGrade, semanticGrade, punctuationGrade];
  var barColors = [colorGradeDecider(grammarGrade), colorGradeDecider(semanticGrade), colorGradeDecider(punctuationGrade)];
  
  new Chart(canvas, {
    type: "bar",
    data: {
      labels: xValues,
      datasets: [{
        backgroundColor: barColors,
        data: yValues
      }]
    },
    options: {
      legend: {display: false},
      title: {
        display: true,
        text: "Description grades by model"
      },
      scales: {
        yAxes: [{
            display: true,
            ticks: {
                suggestedMin: 0,
                max: 100
            }
        }]
      }
    }
  });
  
  div.appendChild(canvas);
  return div;
}

function DivCreator(values, modelName) {
  var gradeNumber = Math.round(values[0] * 100);
  var commentValue = values[1];
  var div = document.createElement("div");
  var title = document.createElement("strong");
  title.textContent = modelName + ":";
  div.style.textAlign = "left";
  title.style.textDecoration = "underline";
  title.style.fontSize = "larger";
  var span = document.createElement("span");
  span.className = "circle";
  span.textContent = gradeNumber + "%"
  if (modelName == "Brightness") {
    span.style.color = colorBrightnessGradeDecider(gradeNumber);
  }
  else {
    if (modelName == "Mess") {
      span.style.color = colorMessGradeDecider(gradeNumber);
    }
    else {
      span.style.color = colorGradeDecider(gradeNumber);
    }
  }
  var comment = document.createElement("p");
  comment.textContent = commentValue;
  div.appendChild(title);
  div.appendChild(span);
  div.appendChild(comment);
  return div;
}

function imgCreator(files, i, fromOldReports) {
  if (fromOldReports) {
    file = files[i];
    console.log(file.image);
    return files[i].image;
  }
  else {
    var img = document.createElement("img");
    img.src = URL.createObjectURL(files[i]);
    img.className = "imges-card-img-top card-img-top imagesResponse";
    img.alt = "Card image cap";
    return img;
  }
}

function cardImagesCreator(report, files, fromOldReports) {
  if (files != "undefined") {
    if (files.length > 0) {
      console.log(files)
      var mainCard = document.createElement("div");
      mainCard.className = "images-card-deck";
      mainCard.innerHTML = '';
      for (let i = 0; i < files.length; i++) {
        var quality = qualityCalculator(report, files[i].name)
        var qualityDiv = DivCreator(quality, "Quality");
        var brightness = brightnessCalculator(report, files[i].name)
        var brightnessDiv = DivCreator(brightness, "Brightness");
        var messyRoom = messCalculator(report, files[i].name)
        var messyRoomDiv = DivCreator(messyRoom, "Mess");
        var triq = triqCalculator(report, files[i].name)
        var triqDiv = DivCreator(triq, "Triq");
        var card = document.createElement("div");
        card.className = "cardImages card"
        var img = imgCreator(files, i, fromOldReports);
        card.appendChild(img);
        console.log(files[i].name);
        var cardBody = document.createElement("div");
        cardBody.className = "card-body";
        var cardTitle = document.createElement("p");
        cardTitle.textContent = files[i].name;
        cardBody.appendChild(cardTitle);
        cardBody.appendChild(qualityDiv);
        cardBody.appendChild(brightnessDiv);
        cardBody.appendChild(messyRoomDiv);
        cardBody.appendChild(triqDiv);
        card.appendChild(cardBody);
        mainCard.appendChild(card);
      }
      return mainCard;
    }
  }
}

function qualityCalculator(report, fileName) {
  console.log(report.i_quality_rate);
  for(let i = 0; i < report.i_quality_rate.length; i++) {
    console.log("images\\" + fileName)
    if (report.i_quality_rate[i][2] == ("images\\" + fileName)) {
      return report.i_quality_rate[i]
    }
  }
}

function brightnessCalculator(report, fileName) {
  for(let i = 0; i < report.i_bright_rate.length; i++) {
    console.log("images\\" + fileName)
    if (report.i_bright_rate[i][2] == ("images\\" + fileName)) {
      console.log('true');
      return report.i_bright_rate[i]
    }
  }
}

function messCalculator(report, fileName) {
  for(let i = 0; i < report.i_messy_rate.length; i++) {
    console.log("images\\" + fileName)
    if (report.i_messy_rate[i][2] == ("images\\" + fileName)) {
      return report.i_messy_rate[i]
    }
  }
}

function triqCalculator(report, fileName) {
  for(let i = 0; i < report.i_triq_model.length; i++) {
    console.log("images\\" + fileName)
    if (report.i_triq_model[i][2] == ("images\\" + fileName)) {
      return report.i_triq_model[i]
    }
  }
}

function loadImagesBanner(report, photos, fromOldReports) {
  var div = document.createElement("div");
  if (report.num_of_images != -1) {
    console.log("Suggest the user to add more images.");
    var pNotEnoughImages = document.createElement("p")
    pNotEnoughImages.textContent = report.num_of_images;
    div.appendChild(pNotEnoughImages);
  }
  div.appendChild(cardImagesCreator(report, photos, fromOldReports));
  div.appendChild(imagesChart(report));
  return div;
}

function imagesChart(response) {
  var imagesLabels = getImagesLabels(response);
  console.log(imagesLabels);
  var brightnessGrades = getBrightnessGrades(response);
  var messGrades = getMessGrades(response);
  var triqGrades = getTriqGrades(response);
  var qualityGrades = getQualityGrades(response);
  return createImagesChart(response, imagesLabels, brightnessGrades, messGrades, triqGrades, qualityGrades);
}

function getImagesLabels(response) {
  var imagesLabels = [];
  if (response.i_bright_rate.length != response.i_messy_rate.length || response.i_bright_rate.length != response.i_triq_model.length
    || response.i_bright_rate.length != response.i_quality_rate.length) {
      console.log("Not all the models returns answer to all of the images. The chart might be wrong")
    }
  for(let i = 0; i < response.i_bright_rate.length; i++) {
    file_name = response.i_bright_rate[i][2];
    file_name = file_name.split('\\')[1];
    imagesLabels.push(file_name);
  }
  return imagesLabels;
}

function getBrightnessGrades(response) {
  var brightnessGrades = [];
  for(let i = 0; i < response.i_bright_rate.length; i++) {
    grade = Math.round(response.i_bright_rate[i][0] * 100);
    brightnessGrades.push(grade);
  }
  return brightnessGrades;
}

function getMessGrades(response) {
  var messGrades = [];
  for(let i = 0; i < response.i_messy_rate.length; i++) {
    grade = Math.round(response.i_messy_rate[i][0] * 100);
    messGrades.push(grade);
  }
  return messGrades;
}

function getTriqGrades(response) {
  var triqGrades = [];
  for(let i = 0; i < response.i_triq_model.length; i++) {
    grade = Math.round(response.i_triq_model[i][0] * 100);
    triqGrades.push(grade);
  }
  return triqGrades;
}

function getQualityGrades(response) {
  var qualityGrades = [];
  for(let i = 0; i < response.i_quality_rate.length; i++) {
    grade = Math.round(response.i_quality_rate[i][0] * 100);
    qualityGrades.push(grade);
  }
  return qualityGrades;
}

function createImagesChart(response, imagesLabels, brightnessGrades, messGrades, triqGrades, qualityGrades) {
  var div = document.createElement("div");
  div.className = "canvas-container";

  var canvas = document.createElement("canvas");
  canvas.style.width = "50%";
  canvas.style.maxWidth = "600px";

  new Chart(canvas, {
    type: "line",
    data: {
      labels: imagesLabels,
      datasets: [{
          data: brightnessGrades,
          label: "Brightness Grades",
          borderColor: "#8e5ea2",
          fill: false
        }, {
          data: messGrades,
          label: "Mess Grades",
          borderColor: "#3cba9f",
          fill: false
        }, {
          data: triqGrades,
          label: "Triq Grades",
          borderColor: "#c45850",
          fill: false
        }, {
          data: qualityGrades,
          label: "Quality Grades",
          borderColor: "#3e95cd",
          fill: false
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: 'Summary grades of all images'
      }
    }
  });

  div.appendChild(canvas);
  return div;
}

function loadAllReports(allReportsRequest) {
  // TODO: delete the following line:
  allReportsRequest = allReportsResponse;
  console.log(allReportsRequest);
  console.log("There are " + Object.keys(allReportsRequest).length + " reports");

  if (Object.keys(allReportsRequest).length > 1) {
    createLoadReportsButton(allReportsRequest);
  }
}

function createLoadReportsButton(allReportsRequest) {
  var oldReportsSec = document.getElementById("oldReports");
  oldReportsSec.innerHTML = '';
  var loadReportsButton = document.createElement("loadReportsButton");
  loadReportsButton.innerHTML = "Load old reports";
  loadReportsButton.className = "btn btn-success btn-imgs";
  loadReportsButton.onclick = function () {
    console.log("The user has requested to load older reports")
    createTabs(allReportsRequest);
  };
  oldReportsSec.appendChild(loadReportsButton);
  var reportsInfo = document.createElement("reportsInfo");
  reportsInfo.id = "reportsInfo";
  oldReportsSec.appendChild(reportsInfo);
}

function createTabs(allReportsRequest) {
  var reportsInfo = document.getElementById("reportsInfo");
  reportsInfo.innerHTML = '';
  var nav = document.createElement("div");
  nav.className = "m-4";

  var divTabs = document.createElement("ul");
  divTabs.className = "nav nav-tabs";
  divTabs.id = "myTab";

  var divContent = document.createElement("div");
  divContent.className = "tab-content";

  for (let i = Object.keys(allReportsRequest).length - 2; i >= 0; i--) {
    tabList = createTabList(allReportsRequest, i + 1, Object.keys(allReportsRequest).length - 1);
    divTabs.appendChild(tabList);

    tabContent = createTabContent(allReportsRequest, i, Object.keys(allReportsRequest).length - 2);
    divContent.appendChild(tabContent);
    if (Object.keys(allReportsRequest).length - 1 - i == 10) {
      i = -1;
    }
  }

  nav.appendChild(divTabs);
  nav.appendChild(divContent);
  reportsInfo.appendChild(nav);
}

function createTabList(allReportsRequest, reportIdx, lastReportIdx) {
  var liTab = document.createElement("li");

  liTab.className = "nav-item";
  var inTab = document.createElement("a");
  inTab.href = "#reportContent" + reportIdx;
  if (reportIdx == lastReportIdx) {
    inTab.className = "nav-link active";
  }
  else {
    inTab.className = "nav-link";
  }
  inTab.textContent = "Report #" + reportIdx;

  var tabTrigger = new bootstrap.Tab(inTab);
  inTab.addEventListener("click", function(event){
    event.preventDefault();
    tabTrigger.show();
  });

  liTab.appendChild(inTab);
  return liTab;
}

function createTabContent(allReportsRequest, reportIdx, lastReportIdx) {
  var reportIdxDisplay = reportIdx + 1;
  var div = document.createElement("div");
  div.id = "reportContent" + reportIdxDisplay;
  if (reportIdx == lastReportIdx) {
    div.className = "tab-pane fade show active";
  }
  else {
    div.className = "tab-pane fade";
  }
  pageContent = createOldReportContent(allReportsRequest[reportIdx]);
  div.appendChild(pageContent);
  return div;
}

function createOldReportContent(report) {
  console.log(report);
  var pageContent = document.createElement("div");
  pageContent.className = "images-card-deck-reports accordion-body";

  if (report.description != "undefined" && report.description != "") {
    descriptionContent = createDescriptionOldReport(report);
    pageContent.appendChild(descriptionContent);
  }
  if (report.photos != "undefined" && !(Object.keys(report.photos).length === 0)) {
    imagesContent = createImagesOldReport(report);
    pageContent.appendChild(imagesContent);  
  }
  return pageContent;
}

function createDescriptionOldReport(report) {
  var descriptionContent = document.createElement("div");
  descriptionContent.className = "card cardImages"
  var cardBody = document.createElement("div");
  cardBody.className = "card-body";
  var cardTitle = document.createElement("p");
  cardTitle.textContent = "Description Analysis";
  cardTitle.style.fontSize = "larger";
  cardBody.appendChild(cardTitle);
  descriptionContent.appendChild(cardBody);

  descriptionContent.appendChild(cardTitle);
  descriptionContent.appendChild(getDescription(report));

  descriptionContent.appendChild(createDescriptionModelsAnalysis(report));
  descriptionContent.appendChild(createDescriptionChart(report));
  
  return descriptionContent;
}

function createDescriptionModelsAnalysis(report) {
  var section = document.createElement("section");
  section.className = "descriptionAnalysis-grid";

  section.appendChild(createGrammarAnalysis(report));
  section.appendChild(createSemanticAnalysis(report));
  section.appendChild(createPunctuationAnalysis(report));
  return section;
}

function createGrammarAnalysis(report) {
  var div = document.createElement("div");
  div.className = "grammarAnalysis-grid";
  
  var title = document.createElement("strong");
  title.style.textDecoration = "underline";
  title.style.fontSize = "larger";
  title.textContent = "Grammar Analysis";
  div.appendChild(title);
  
  var grammarGrade = report.grammar_model.grade;
  var spanGrade = document.createElement("span");
  spanGrade.className = "circle";
  spanGrade.textContent = grammarGrade + "%";
  spanGrade.style.color = colorGradeDecider(grammarGrade);
  div.appendChild(spanGrade);

  var pMainResponse = document.createElement("p");
  pMainResponse.textContent = response.grammar_model.main_response;
  div.appendChild(pMainResponse);

  div.appendChild(grammarDescriptionIssuesList(report));
  div.appendChild(suggestedDescription(report));

  return div;
}

function suggestedDescription(report) {
  var divReplacementDescription = document.createElement("div");
  var replacementDescription = document.createElement("strong");
  replacementDescription.textContent = "Our suggested description is: ";
  divReplacementDescription.style.textAlign = "left";
  divReplacementDescription.appendChild(replacementDescription);
  
  var pDivReplacementDescription = document.createElement("p");
  pDivReplacementDescription.textContent = report.grammar_model.replacement_description;
  divReplacementDescription.appendChild(pDivReplacementDescription);
  return divReplacementDescription;
}

function getDescription(report) {
  var p = document.createElement("p");
  p.textContent = report.description;
  p.className = "boxed";
  return p;
}

function createSemanticAnalysis(report) {
  var div = document.createElement("div");
  div.className = "semanticAnalysis-grid";
  
  var title = document.createElement("strong");
  title.style.textDecoration = "underline";
  title.style.fontSize = "larger";
  title.textContent = "Semantic Analysis";
  div.appendChild(title);
  
  var semanticGrade = Math.round(report.semantic_model[0] * 100);
  var spanGrade = document.createElement("span");
  spanGrade.className = "circle";
  spanGrade.textContent = semanticGrade + "%";
  spanGrade.style.color = colorGradeDecider(semanticGrade);
  div.appendChild(spanGrade);

  var pMainResponse = document.createElement("p");
  pMainResponse.textContent = report.semantic_model[1];
  div.appendChild(pMainResponse);

  return div;
}

function createPunctuationAnalysis(report) {
  var div = document.createElement("div");
  div.className = "punctuationAnalysis-grid";
  
  var title = document.createElement("strong");
  title.style.textDecoration = "underline";
  title.style.fontSize = "larger";
  title.textContent = "Punctuation Analysis";
  div.appendChild(title);
  
  var punctuationGrade = Math.round(report.punctuation_model[0] * 100);
  var spanGrade = document.createElement("span");
  spanGrade.className = "circle";
  spanGrade.textContent = punctuationGrade + "%";
  spanGrade.style.color = colorGradeDecider(punctuationGrade);
  div.appendChild(spanGrade);

  var pMainResponse = document.createElement("p");
  pMainResponse.textContent = report.punctuation_model[1]
  div.appendChild(pMainResponse);

  return div;
}

function createImagesOldReport(report) {
  var imagesContent = document.createElement("div");
  imagesContent.className = "card cardImages"
  var cardBody = document.createElement("div");
  cardBody.className = "card-body";
  var cardTitle = document.createElement("p");
  cardTitle.textContent = "Images Analysis";
  cardTitle.style.fontSize = "larger";
  cardBody.appendChild(cardTitle);
  imagesContent.appendChild(cardBody);
  imagesContent.appendChild(cardTitle);

  photos = getPhotos(report);
  imagesContent.appendChild(loadImagesBanner(report, photos, 1)); 

  return imagesContent;
}

function getPhotos(report) {
  var photos = [];
  for(var key in report.photos) {
    var photo = {};
    photo["name"] = key;
    var base64img = getBase64Img(report, key);

    Base64ToImage(base64img, photo);
    photos.push(photo);
  }
  console.log(photos);
  return photos;
}

function getBase64Img(report, key) {
  return "data:image/png;base64," + report.photos[key];
}

function Base64ToImage(base64img, photo) {
  var img = new Image();
  img.src = base64img;
  img.className = "imges-card-img-top card-img-top imagesResponse";
  img.alt = "Card image cap";
  photo["image"] = img;
}